<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Logic Game: Đoán Số Trung Bình</title>
    <!-- Tải Tailwind CSS để làm đẹp giao diện -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* CSS tùy chỉnh cho game */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Thêm font Inter */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap");

      /* Hiệu ứng mượt mà cho các khối */
      .game-state {
        transition: all 0.3s ease-in-out;
      }

      /* Style cho người chơi bị loại */
      .player-card.eliminated {
        opacity: 0.4;
        filter: grayscale(100%);
        border-color: #ef4444; /* red-500 */
      }

      /* Style cho người chơi thắng vòng */
      .player-card.winner {
        border-color: #22c55e; /* green-500 */
        box-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
      }

      /* Style cho người chơi thua vòng */
      .player-card.loser {
        border-color: #f97316; /* orange-500 */
      }

      /* Tùy chỉnh thanh trượt */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 10px;
        background: #4b5563; /* gray-600 */
        border-radius: 5px;
        outline: none;
        opacity: 0.9;
        transition: opacity 0.2s;
      }
      input[type="range"]:hover {
        opacity: 1;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #3b82f6; /* blue-500 */
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid white;
      }
      input[type="range"]::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #3b82f6; /* blue-500 */
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid white;
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white p-4 md:p-8 min-h-screen flex items-center justify-center"
  >
    <!-- Container chính của ứng dụng -->
    <div id="app" class="w-full max-w-5xl mx-auto">
      <!-- Màn hình tải/xác thực -->
      <div id="auth-view" class="text-center">
        <h1 class="text-2xl font-bold mb-4">Đang kết nối đến máy chủ...</h1>
        <div
          class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto"
        ></div>
        <p class="mt-4 text-sm text-gray-400">
          UserID của bạn:
          <span id="user-id-display" class="font-mono">...</span>
        </p>
      </div>

      <!-- Màn hình chọn phòng -->
      <div
        id="room-view"
        class="hidden w-full max-w-md mx-auto bg-gray-800 p-6 rounded-lg shadow-xl"
      >
        <h1 class="text-3xl font-bold text-center mb-6">Game Đoán Số</h1>
        <div class="mb-4">
          <label
            for="player-name"
            class="block text-sm font-medium text-gray-300 mb-2"
            >Tên của bạn</label
          >
          <input
            type="text"
            id="player-name"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Nhập tên của bạn..."
          />
        </div>
        <button
          id="create-room-btn"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg"
        >
          Tạo phòng mới
        </button>
        <div class="relative flex items-center justify-center my-6">
          <div class="absolute inset-0 flex items-center">
            <span class="w-full border-t border-gray-600"></span>
          </div>
          <span class="relative px-3 bg-gray-800 text-sm text-gray-400"
            >hoặc</span
          >
        </div>
        <div class="mb-4">
          <label
            for="room-id-input"
            class="block text-sm font-medium text-gray-300 mb-2"
            >ID Phòng</label
          >
          <input
            type="text"
            id="room-id-input"
            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
            placeholder="Nhập ID phòng để tham gia..."
          />
        </div>
        <button
          id="join-room-btn"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg"
        >
          Tham gia phòng
        </button>
      </div>

      <!-- Màn hình Game chính -->
      <div id="game-view" class="hidden w-full">
        <!-- Header thông tin phòng -->
        <div
          id="game-header"
          class="mb-4 p-4 bg-gray-800 rounded-lg shadow-md flex flex-col md:flex-row justify-between items-center gap-2"
        >
          <div>
            <span class="text-gray-400">Room ID:</span>
            <strong
              id="room-id-display"
              class="text-lg font-bold text-yellow-400 cursor-pointer"
              title="Nhấn để copy"
              >...</strong
            >
          </div>
          <div class="text-gray-400">
            Vòng:
            <strong id="round-display" class="text-lg text-white">0</strong>
          </div>
          <div>
            <span class="text-gray-400">Your UserID:</span>
            <strong
              id="game-user-id-display"
              class="text-sm font-mono text-gray-300"
              >...</strong
            >
          </div>
        </div>

        <!-- Danh sách người chơi -->
        <div
          id="player-list"
          class="mb-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"
        >
          <!-- Thẻ người chơi sẽ được thêm bằng JS -->
        </div>

        <!-- Các trạng thái của Game -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
          <!-- Trạng thái: Phòng chờ (Lobby) -->
          <div id="lobby-state" class="game-state hidden text-center">
            <h2 class="text-2xl font-bold mb-4">Đang chờ người chơi...</h2>
            <p class="text-gray-400 mb-6">
              Cần ít nhất 3 người chơi sẵn sàng để bắt đầu.
            </p>
            <button
              id="ready-btn"
              class="w-full max-w-xs mx-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 shadow-lg"
            >
              Sẵn sàng
            </button>
          </div>

          <!-- Trạng thái: Đang chơi (Playing) -->
          <div id="playing-state" class="game-state hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
            >
              <h2 class="text-2xl font-bold text-center md:text-left">
                Vòng <span id="playing-round-display"></span>: Chọn một số!
              </h2>
              <div class="text-6xl font-black text-red-500" id="timer-display">
                60
              </div>
            </div>

            <div class="max-w-lg mx-auto">
              <div class="flex justify-between items-center mb-2">
                <label for="number-slider" class="text-lg font-medium"
                  >Chọn số (1-100)</label
                >
                <span
                  id="slider-value"
                  class="text-3xl font-bold text-blue-400 bg-gray-700 px-4 py-1 rounded-lg"
                  >50</span
                >
              </div>
              <input
                type="range"
                id="number-slider"
                min="1"
                max="100"
                value="50"
                class="w-full mb-6"
              />

              <button
                id="submit-number-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 shadow-lg"
              >
                Chốt số!
              </button>
            </div>

            <div id="waiting-for-others" class="hidden text-center mt-8">
              <p class="text-xl text-gray-400">
                Đã chốt số! Đang chờ người khác...
              </p>
              <div
                class="w-12 h-12 border-4 border-blue-400 border-t-transparent rounded-full animate-spin mx-auto mt-4"
              ></div>
            </div>
          </div>

          <!-- Trạng thái: Kết thúc vòng (Round End) -->
          <div id="round-end-state" class="game-state hidden text-center">
            <h2 class="text-3xl font-bold mb-4">
              Kết quả Vòng <span id="round-end-round-display"></span>
            </h2>
            <p class="text-xl text-gray-300 mb-6">
              Số trung bình là:
              <strong
                id="average-display"
                class="text-4xl font-bold text-yellow-400 mx-2"
                >0.00</strong
              >
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-xl font-semibold text-green-400 mb-3">
                  Thắng vòng (+1 điểm)
                </h3>
                <ul id="winners-list" class="list-disc list-inside text-left">
                  <!-- JS thêm người thắng -->
                </ul>
              </div>
              <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="text-xl font-semibold text-red-400 mb-3">
                  Thua vòng
                </h3>
                <ul id="losers-list" class="list-disc list-inside text-left">
                  <!-- JS thêm người thua -->
                </ul>
              </div>
            </div>

            <button
              id="next-round-btn"
              class="hidden w-full max-w-xs mx-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 shadow-lg"
            >
              Bắt đầu vòng tiếp theo
            </button>
            <p id="waiting-for-host" class="text-gray-400">
              Chờ chủ phòng bắt đầu vòng tiếp theo...
            </p>
          </div>

          <!-- Trạng thái: Kết thúc Game (Game End) -->
          <div id="game-end-state" class="game-state hidden text-center">
            <h2 class="text-4xl font-bold mb-8">Game Kết Thúc!</h2>

            <h3 class="text-2xl font-semibold mb-4">Bảng Xếp Hạng</h3>
            <div id="rankings" class="space-y-3 max-w-md mx-auto">
              <!-- 
                        <div class="flex justify-between items-center bg-gray-700 p-4 rounded-lg text-lg">
                            <span class="font-bold text-yellow-300">🥇 1. Player Name</span>
                            <span class="font-bold">20 điểm</span>
                        </div>
                        -->
            </div>

            <button
              id="reset-game-btn"
              class="hidden w-full max-w-xs mx-auto mt-8 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 shadow-lg"
            >
              Chơi lại
            </button>
            <p id="waiting-for-reset" class="text-gray-400 mt-4">
              Chờ chủ phòng chơi lại...
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay tải -->
    <div
      id="loading-overlay"
      class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"
    >
      <div
        class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin"
      ></div>
    </div>

    <!-- Hộp thông báo tùy chỉnh -->
    <div
      id="message-box"
      class="hidden fixed top-5 right-5 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-xl z-50 transition-all duration-300 transform translate-x-full"
    >
      <span id="message-text"></span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
      // Import các module cần thiết từ Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        Timestamp,
        writeBatch,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- BIẾN TOÀN CỤC ---
      let app, db, auth;
      let userId = null; // ID người dùng sau khi xác thực
      let currentRoomId = null; // ID phòng hiện tại
      let unsubscribeRoom = null; // Hàm để hủy lắng nghe snapshot
      let hostTimer = null; // Timer của chủ phòng để tính toán
      let uiTimerInterval = null; // Timer của UI để đếm ngược
      let isHost = false; // Người chơi này có phải chủ phòng không

      // --- BIẾN CẤU HÌNH (Đã nhúng tĩnh) ---
      // 'appId' này dùng để phân tách dữ liệu trong Firestore
      const appId = "near-the-mean-game"; // Đổi tên để khớp với dự án của bạn

      // Cấu hình Firebase do người dùng cung cấp
      const firebaseConfig = {
        apiKey: "AIzaSyAtk6aeWYBNKrBasdUkxVx6tIvy4Xe7jA8",
        authDomain: "near-the-mean.firebaseapp.com",
        projectId: "near-the-mean",
        storageBucket: "near-the-mean.firebasestorage.app", // Sửa lỗi cú pháp 'firebasestorage'
        messagingSenderId: "204542056653",
        appId: "1:204542056653:web:ad8e3c574dc24c3eb7b184",
        measurementId: "G-H6E91RRXXK",
      };

      // Bỏ qua custom token, chỉ dùng đăng nhập ẩn danh
      const initialAuthToken = null;

      // --- CÁC ĐỐI TƯỢNG DOM ---
      const authView = document.getElementById("auth-view");
      const roomView = document.getElementById("room-view");
      const gameView = document.getElementById("game-view");
      const loadingOverlay = document.getElementById("loading-overlay");
      const userIdDisplay = document.getElementById("user-id-display");

      const playerNameInput = document.getElementById("player-name");
      const roomIdInput = document.getElementById("room-id-input");
      const createRoomBtn = document.getElementById("create-room-btn");
      const joinRoomBtn = document.getElementById("join-room-btn");

      const roomIdDisplay = document.getElementById("room-id-display");
      const gameUserIdDisplay = document.getElementById("game-user-id-display");
      const roundDisplay = document.getElementById("round-display");
      const playerList = document.getElementById("player-list");

      const lobbyState = document.getElementById("lobby-state");
      const readyBtn = document.getElementById("ready-btn");

      const playingState = document.getElementById("playing-state");
      const playingRoundDisplay = document.getElementById(
        "playing-round-display"
      );
      const timerDisplay = document.getElementById("timer-display");
      const numberSlider = document.getElementById("number-slider");
      const sliderValue = document.getElementById("slider-value");
      const submitNumberBtn = document.getElementById("submit-number-btn");
      const waitingForOthers = document.getElementById("waiting-for-others");

      const roundEndState = document.getElementById("round-end-state");
      const roundEndRoundDisplay = document.getElementById(
        "round-end-round-display"
      );
      const averageDisplay = document.getElementById("average-display");
      const winnersList = document.getElementById("winners-list");
      const losersList = document.getElementById("losers-list");
      const nextRoundBtn = document.getElementById("next-round-btn");
      const waitingForHost = document.getElementById("waiting-for-host");

      const gameEndState = document.getElementById("game-end-state");
      const rankings = document.getElementById("rankings");
      const resetGameBtn = document.getElementById("reset-game-btn");
      const waitingForReset = document.getElementById("waiting-for-reset");

      // --- HÀM TIỆN ÍCH ---

      /**
       * Hiển thị thông báo tùy chỉnh thay vì alert()
       * @param {string} message - Nội dung thông báo
       * @param {boolean} isError - Có phải là lỗi không (đổi màu)
       */
      function showMessage(message, isError = false) {
        const msgBox = document.getElementById("message-box");
        const msgText = document.getElementById("message-text");

        msgText.textContent = message;
        msgBox.classList.remove(
          "hidden",
          "translate-x-full",
          "bg-blue-500",
          "bg-red-500"
        );

        if (isError) {
          msgBox.classList.add("bg-red-500");
        } else {
          msgBox.classList.add("bg-blue-500");
        }

        // Hiện
        msgBox.classList.remove("translate-x-full");

        // Ẩn sau 3 giây
        setTimeout(() => {
          msgBox.classList.add("translate-x-full");
        }, 3000);
      }

      /**
       * Tạo ID phòng ngẫu nhiên
       * @param {number} length - Độ dài ID
       */
      function createRoomId(length = 6) {
        return Math.random()
          .toString(36)
          .substring(2, 2 + length)
          .toUpperCase();
      }

      /**
       * Hiển thị/Ẩn overlay tải
       * @param {boolean} show - Hiển thị hay ẩn
       */
      function showLoading(show) {
        loadingOverlay.classList.toggle("hidden", !show);
      }

      /**
       * Chuyển đổi giữa các màn hình chính
       * @param {string} viewName - 'auth', 'room', 'game'
       */
      function switchView(viewName) {
        authView.classList.add("hidden");
        roomView.classList.add("hidden");
        gameView.classList.add("hidden");

        if (viewName === "auth") authView.classList.remove("hidden");
        if (viewName === "room") roomView.classList.remove("hidden");
        if (viewName === "game") gameView.classList.remove("hidden");
      }

      /**
       * Lấy đường dẫn document của phòng
       * @param {string} rId - Room ID
       */
      function getRoomRef(rId) {
        // Sử dụng appId đã định nghĩa ở trên
        return doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "average-game-rooms",
          rId
        );
      }

      // --- KHỞI TẠO FIREBASE ---

      async function initFirebase() {
        try {
          // Kiểm tra nếu firebaseConfig rỗng (trường hợp người dùng dán sai)
          if (!firebaseConfig.apiKey) {
            showMessage("Lỗi cấu hình Firebase. Không thể khởi tạo.", true);
            console.error("Lỗi: firebaseConfig rỗng hoặc không hợp lệ.");
            authView.innerHTML =
              '<h1 class="text-2xl font-bold mb-4 text-red-500">Lỗi Cấu hình Firebase</h1><p>Vui lòng kiểm tra lại firebaseConfig trong file index.html.</p>';
            return;
          }

          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Lắng nghe thay đổi trạng thái xác thực
          onAuthStateChanged(auth, (user) => {
            if (user) {
              console.log("User is signed in:", user.uid);
              userId = user.uid;
              userIdDisplay.textContent = userId;
              gameUserIdDisplay.textContent = userId;
              switchView("room"); // Chuyển đến màn hình chọn phòng
            } else {
              console.log("User is signed out.");
              userId = null;
              switchView("auth");
              signIn(); // Tự động đăng nhập nếu chưa
            }
          });
        } catch (error) {
          console.error("Lỗi khởi tạo Firebase:", error);
          showMessage("Không thể kết nối đến máy chủ. Vui lòng tải lại.", true);
          authView.innerHTML = `<h1 class="text-2xl font-bold mb-4 text-red-500">Lỗi Khởi tạo Firebase</h1><p class="text-gray-400">${error.message}</p>`;
        }
      }

      /**
       * Đăng nhập người dùng (Đã đơn giản hóa)
       */
      async function signIn() {
        try {
          // Chỉ sử dụng đăng nhập ẩn danh
          console.log("Signing in anonymously...");
          await signInAnonymously(auth);
        } catch (error) {
          console.error("Lỗi đăng nhập:", error);
          showMessage("Lỗi đăng nhập. Vui lòng kiểm tra kết nối.", true);
        }
      }

      // --- LOGIC PHÒNG VÀ LOBBY ---

      /**
       * Xử lý tạo phòng
       */
      async function handleCreateRoom() {
        const playerName = playerNameInput.value.trim();
        if (!playerName) {
          showMessage("Vui lòng nhập tên của bạn!", true);
          return;
        }

        showLoading(true);
        const newRoomId = createRoomId();
        const roomRef = getRoomRef(newRoomId);

        const newPlayer = {
          name: playerName,
          score: 5,
          isReady: false,
          isEliminated: false,
          currentChoice: null,
          submittedThisRound: false,
        };

        const roomData = {
          roomId: newRoomId,
          hostId: userId,
          gameState: "lobby", // "lobby", "playing", "roundEnd", "gameEnd"
          round: 0,
          roundDeadline: null,
          roundAverage: null,
          roundWinners: [],
          roundLosers: {},
          initialPlayerCount: 1,
          players: {
            [userId]: newPlayer,
          },
          createdAt: Timestamp.now(),
        };

        try {
          await setDoc(roomRef, roomData);
          await joinRoom(newRoomId, playerName);
        } catch (error) {
          console.error("Lỗi tạo phòng:", error);
          showMessage("Lỗi tạo phòng. Vui lòng thử lại.", true);
        } finally {
          showLoading(false);
        }
      }

      /**
       * Xử lý tham gia phòng
       */
      async function handleJoinRoom() {
        const playerName = playerNameInput.value.trim();
        if (!playerName) {
          showMessage("Vui lòng nhập tên của bạn!", true);
          return;
        }

        const rId = roomIdInput.value.trim().toUpperCase();
        if (!rId) {
          showMessage("Vui lòng nhập ID phòng!", true);
          return;
        }

        showLoading(true);
        const roomRef = getRoomRef(rId);

        try {
          const roomSnap = await getDoc(roomRef);
          if (!roomSnap.exists()) {
            showMessage("Phòng không tồn tại!", true);
            return;
          }

          const roomData = roomSnap.data();

          // Không cho tham gia nếu game đã bắt đầu
          if (roomData.gameState !== "lobby") {
            showMessage("Game đã bắt đầu, không thể tham gia!", true);
            return;
          }

          // Không cho tham gia nếu quá 10 người
          if (Object.keys(roomData.players).length >= 10) {
            showMessage("Phòng đã đầy (tối đa 10 người)!", true);
            return;
          }

          // Thêm người chơi mới
          const newPlayer = {
            name: playerName,
            score: 5,
            isReady: false,
            isEliminated: false,
            currentChoice: null,
            submittedThisRound: false,
          };

          await updateDoc(roomRef, {
            [`players.${userId}`]: newPlayer,
          });

          await joinRoom(rId, playerName);
        } catch (error) {
          console.error("Lỗi tham gia phòng:", error);
          showMessage("Lỗi tham gia phòng. Vui lòng thử lại.", true);
        } finally {
          showLoading(false);
        }
      }

      /**
       * Thiết lập lắng nghe khi vào phòng
       * @param {string} rId - Room ID
       */
      function joinRoom(rId, playerName) {
        currentRoomId = rId;
        const roomRef = getRoomRef(rId);

        // Lưu tên vào localStorage để không phải nhập lại
        localStorage.setItem("playerName", playerName);

        // Hủy lắng nghe cũ (nếu có)
        if (unsubscribeRoom) {
          unsubscribeRoom();
        }

        // Lắng nghe thay đổi của phòng
        unsubscribeRoom = onSnapshot(
          roomRef,
          (docSnap) => {
            if (!docSnap.exists()) {
              // Phòng đã bị xóa (VD: chủ phòng rời)
              showMessage("Phòng không còn tồn tại.", true);
              leaveRoom();
              return;
            }
            const roomData = docSnap.data();
            window.currentRoomData = roomData; // Lưu snapshot mới nhất vào global
            renderGame(roomData); // Hàm render chính

            // Logic tự động bắt đầu game của CHỦ PHÒNG
            if (isHost && roomData.gameState === "lobby") {
              checkAutoStart(roomData);
            }

            // Logic tính toán của CHỦ PHÒNG
            if (isHost && roomData.gameState === "playing") {
              checkAllSubmitted(roomData);
            }
          },
          (error) => {
            console.error("Lỗi lắng nghe phòng:", error);
            showMessage("Mất kết nối với phòng.", true);
            leaveRoom();
          }
        );

        switchView("game");
      }

      /**
       * Rời phòng (quay về màn hình chính)
       */
      function leaveRoom() {
        if (unsubscribeRoom) {
          unsubscribeRoom();
          unsubscribeRoom = null;
        }
        currentRoomId = null;
        isHost = false;
        window.currentRoomData = null;
        if (hostTimer) clearTimeout(hostTimer);
        if (uiTimerInterval) clearInterval(uiTimerInterval);
        switchView("room");
      }

      /**
       * Xử lý sẵn sàng
       */
      async function handleReady() {
        if (!currentRoomId || !userId) return;
        readyBtn.disabled = true;
        readyBtn.textContent = "Đang xử lý...";

        const roomRef = getRoomRef(currentRoomId);
        try {
          // Lấy trạng thái sẵn sàng hiện tại
          const roomSnap = await getDoc(roomRef);
          const currentReadyState = roomSnap.data().players[userId].isReady;

          await updateDoc(roomRef, {
            [`players.${userId}.isReady`]: !currentReadyState,
          });
          // Nút sẽ tự động cập nhật qua onSnapshot
        } catch (error) {
          console.error("Lỗi cập nhật sẵn sàng:", error);
          showMessage("Có lỗi, thử lại sau.", true);
          readyBtn.disabled = false;
        }
      }

      /**
       * (CHỦ PHÒNG) Kiểm tra điều kiện tự động bắt đầu
       */
      function checkAutoStart(roomData) {
        const players = Object.values(roomData.players);
        const activePlayers = players.filter((p) => !p.isEliminated);

        if (activePlayers.length < 3) return; // Chưa đủ 3 người

        const allReady = activePlayers.every((p) => p.isReady);
        if (allReady) {
          console.log("Tất cả đã sẵn sàng! Bắt đầu game...");
          startGame(roomData);
        }
      }

      // --- LOGIC CHÍNH CỦA GAME ---

      /**
       * (CHỦ PHÒNG) Bắt đầu game (hoặc vòng mới)
       */
      async function startGame(roomData) {
        // Dọn dẹp timer cũ
        if (hostTimer) clearTimeout(hostTimer);

        showLoading(true);
        const roomRef = getRoomRef(currentRoomId);
        const deadline = Timestamp.fromDate(new Date(Date.now() + 60000)); // 60 giây

        // Reset trạng thái vòng mới cho người chơi
        const updatedPlayers = { ...roomData.players };
        let activePlayerCount = 0;
        Object.keys(updatedPlayers).forEach((pid) => {
          if (!updatedPlayers[pid].isEliminated) {
            updatedPlayers[pid].currentChoice = null;
            updatedPlayers[pid].submittedThisRound = false;
            activePlayerCount++;
          }
          // Reset isReady sau khi game bắt đầu
          updatedPlayers[pid].isReady = false;
        });

        // Nếu là vòng đầu tiên, lưu số người chơi ban đầu
        const isFirstRound = roomData.round === 0;

        try {
          await updateDoc(roomRef, {
            gameState: "playing",
            round: roomData.round + 1,
            roundDeadline: deadline,
            players: updatedPlayers,
            // Chỉ cập nhật nếu là vòng 1
            ...(isFirstRound && { initialPlayerCount: activePlayerCount }),
          });

          // Chủ phòng đặt timer 60s để tự động tính toán
          hostTimer = setTimeout(calculateResults, 60000);
        } catch (error) {
          console.error("Lỗi bắt đầu game:", error);
        } finally {
          showLoading(false);
        }
      }

      /**
       * (CHỦ PHÒNG) Kiểm tra xem tất cả đã nộp chưa
       */
      function checkAllSubmitted(roomData) {
        if (!roomData || !roomData.players) return;

        const activePlayers = Object.values(roomData.players).filter(
          (p) => !p.isEliminated
        );
        const allSubmitted = activePlayers.every((p) => p.submittedThisRound);

        if (allSubmitted && activePlayers.length > 0) {
          console.log("Tất cả đã nộp, tính toán ngay...");
          if (hostTimer) clearTimeout(hostTimer);
          calculateResults();
        }
      }

      /**
       * Xử lý nộp số
       */
      async function handleSubmitNumber() {
        const number = parseInt(numberSlider.value, 10);
        if (isNaN(number) || number < 1 || number > 100) {
          showMessage("Số không hợp lệ!", true);
          return;
        }

        submitNumberBtn.disabled = true;
        waitingForOthers.classList.remove("hidden");

        const roomRef = getRoomRef(currentRoomId);
        try {
          await updateDoc(roomRef, {
            [`players.${userId}.currentChoice`]: number,
            [`players.${userId}.submittedThisRound`]: true,
          });
        } catch (error) {
          console.error("Lỗi nộp số:", error);
          showMessage("Lỗi nộp số, thử lại!", true);
          submitNumberBtn.disabled = false;
          waitingForOthers.classList.add("hidden");
        }
      }

      /**
       * (CHỦ PHÒNG) Tính toán kết quả vòng
       */
      async function calculateResults() {
        // Dọn dẹp timer
        if (hostTimer) clearTimeout(hostTimer);
        hostTimer = null;

        console.log("Đang tính toán kết quả...");
        const roomRef = getRoomRef(currentRoomId);

        try {
          // Sử dụng batch write để cập nhật 1 lần
          const batch = writeBatch(db);

          // Lấy dữ liệu MỚI NHẤT
          const roomSnap = await getDoc(roomRef);
          if (!roomSnap.exists()) return;
          const roomData = roomSnap.data();

          // Tránh tính toán 2 lần
          if (roomData.gameState !== "playing") {
            console.log("Trạng thái không phải 'playing', bỏ qua tính toán.");
            return;
          }

          const players = roomData.players;
          const updatedPlayers = JSON.parse(JSON.stringify(players)); // Deep copy
          const submissions = [];
          let totalEliminated = 0;

          // 1. Xử lý timeout và đếm người bị loại
          Object.entries(updatedPlayers).forEach(([pid, player]) => {
            if (player.isEliminated) {
              totalEliminated++;
              return; // Bỏ qua nếu đã bị loại từ trước
            }

            // Nếu không nộp bài và game còn đang chơi
            if (!player.submittedThisRound) {
              console.log(
                `Người chơi ${player.name} (${pid}) bị loại do timeout.`
              );
              player.isEliminated = true;
              player.score = -10; // Đảm bảo bị loại
              totalEliminated++;
            } else {
              // Thêm vào danh sách nộp bài hợp lệ
              submissions.push({
                id: pid,
                choice: player.currentChoice,
              });
            }
          });

          // Lấy số người chơi ban đầu
          const initialPlayerCount =
            roomData.initialPlayerCount || Object.keys(players).length;
          let activeSubmitters = submissions.length;
          let average = 0;
          let winners = [];
          let losers = {};
          let roundPenalty = -1;

          // 2. Tính toán hình phạt
          const eliminatedPercentage = totalEliminated / initialPlayerCount;
          if (eliminatedPercentage >= 0.5) {
            roundPenalty = -2;
          }

          let nextGameState = "roundEnd";

          // 3. Tính toán nếu có người nộp bài
          if (activeSubmitters > 0) {
            // 3.1. Tính trung bình
            const sum = submissions.reduce((acc, s) => acc + s.choice, 0);
            average = sum / activeSubmitters;

            // 3.2. Tính khoảng cách
            const distances = submissions.map((s) => ({
              id: s.id,
              dist: Math.abs(s.choice - average),
            }));
            distances.sort((a, b) => a.dist - b.dist);

            // 3.3. Xác định người thắng (25%)
            // Luôn có ít nhất 1 người thắng
            const winnerCount = Math.max(1, Math.ceil(activeSubmitters * 0.25));
            // Lấy khoảng cách của người thứ N
            const winningDistance = distances[winnerCount - 1].dist;

            // Xử lý logic "châm chước" (trùng số)
            // Tất cả những ai có khoảng cách <= winningDistance đều thắng
            winners = distances
              .filter((d) => d.dist <= winningDistance)
              .map((d) => d.id);

            // 3.4. Cập nhật điểm
            submissions.forEach((sub) => {
              const pid = sub.id;
              if (winners.includes(pid)) {
                // Thắng
                updatedPlayers[pid].score += 1;
              } else {
                // Thua
                updatedPlayers[pid].score += roundPenalty;
                losers[pid] = roundPenalty;
              }
            });
          } else {
            // Không ai nộp bài
            average = 0;
          }

          // 4. Kiểm tra loại người chơi do điểm thấp và đếm người còn lại
          let activePlayersAfterRound = 0;
          Object.keys(updatedPlayers).forEach((pid) => {
            if (!updatedPlayers[pid].isEliminated) {
              if (updatedPlayers[pid].score <= -5) {
                updatedPlayers[pid].isEliminated = true;
                console.log(
                  `Người chơi ${updatedPlayers[pid].name} (${pid}) bị loại do điểm <= -5.`
                );
              } else {
                activePlayersAfterRound++;
              }
            }
          });

          // 5. Kiểm tra kết thúc game
          if (activePlayersAfterRound <= 1) {
            nextGameState = "gameEnd";
            console.log("Game kết thúc!");
          }

          // 6. Cập nhật vào batch
          batch.update(roomRef, {
            gameState: nextGameState,
            players: updatedPlayers,
            roundAverage: average,
            roundWinners: winners,
            roundLosers: losers,
          });

          await batch.commit();
        } catch (error) {
          console.error("Lỗi nghiêm trọng khi tính toán kết quả:", error);
          // Thử reset về lobby nếu có lỗi
          await updateDoc(roomRef, { gameState: "lobby" });
        }
      }

      /**
       * (CHỦ PHÒNG) Reset game về lobby
       */
      async function handleResetGame() {
        if (!isHost) return;

        showLoading(true);
        const roomRef = getRoomRef(currentRoomId);

        try {
          // Lấy dữ liệu người chơi hiện tại
          const roomSnap = await getDoc(roomRef);
          const players = roomSnap.data().players;

          // Reset tất cả người chơi
          const updatedPlayers = {};
          Object.keys(players).forEach((pid) => {
            updatedPlayers[pid] = {
              ...players[pid],
              score: 5,
              isReady: false,
              isEliminated: false,
              currentChoice: null,
              submittedThisRound: false,
            };
          });

          await updateDoc(roomRef, {
            gameState: "lobby",
            round: 0,
            roundDeadline: null,
            roundAverage: null,
            roundWinners: [],
            roundLosers: {},
            initialPlayerCount: Object.keys(updatedPlayers).length,
            players: updatedPlayers,
          });
        } catch (error) {
          console.error("Lỗi reset game:", error);
          showMessage("Lỗi reset game.", true);
        } finally {
          showLoading(false);
        }
      }

      // --- HÀM RENDER (CẬP NHẬT GIAO DIỆN) ---

      /**
       * Hàm render chính, điều phối hiển thị
       * @param {object} roomData - Dữ liệu từ Firestore
       */
      function renderGame(roomData) {
        if (!roomData) {
          leaveRoom();
          return;
        }

        // Cập nhật thông tin chung
        isHost = roomData.hostId === userId;
        roomIdDisplay.textContent = roomData.roomId;
        roundDisplay.textContent = roomData.round;

        // Cập nhật danh sách người chơi
        renderPlayerList(roomData);

        // Ẩn tất cả các state
        lobbyState.classList.add("hidden");
        playingState.classList.add("hidden");
        roundEndState.classList.add("hidden");
        gameEndState.classList.add("hidden");

        // Xóa timer UI cũ
        if (uiTimerInterval) clearInterval(uiTimerInterval);

        // Hiển thị state phù hợp
        switch (roomData.gameState) {
          case "lobby":
            renderLobby(roomData);
            break;
          case "playing":
            renderPlaying(roomData);
            break;
          case "roundEnd":
            renderRoundEnd(roomData);
            break;
          case "gameEnd":
            renderGameEnd(roomData);
            break;
        }
      }

      /**
       * Render danh sách người chơi
       */
      function renderPlayerList(roomData) {
        playerList.innerHTML = ""; // Xóa list cũ
        const players = roomData.players;

        // Xử lý trường hợp không có người chơi (ví dụ: lỗi)
        if (!players || Object.keys(players).length === 0) return;

        const myData = players[userId];

        // Sắp xếp: người chơi hiện tại lên đầu, sau đó theo tên
        const sortedPlayerIds = Object.keys(players).sort((a, b) => {
          if (a === userId) return -1;
          if (b === userId) return 1;
          return players[a].name.localeCompare(players[b].name);
        });

        sortedPlayerIds.forEach((pid) => {
          const player = players[pid];
          const card = document.createElement("div");
          card.className =
            "player-card bg-gray-800 p-3 md:p-4 rounded-lg shadow-lg border-2 border-transparent transition-all duration-300";

          let readyIndicator = "";
          if (roomData.gameState === "lobby" && !player.isEliminated) {
            if (player.isReady) {
              readyIndicator =
                '<div class="w-full bg-green-500 h-2 rounded-full mt-2" title="Sẵn sàng"></div>';
            } else {
              readyIndicator =
                '<div class="w-full bg-gray-600 h-2 rounded-full mt-2" title="Chưa sẵn sàng"></div>';
            }
          }

          let choiceDisplay = "?";
          if (player.isEliminated) {
            choiceDisplay = "BỊ LOẠI";
          } else if (
            roomData.gameState === "playing" &&
            player.submittedThisRound
          ) {
            choiceDisplay = pid === userId ? player.currentChoice : "ĐÃ CHỌN";
          } else if (
            roomData.gameState === "roundEnd" ||
            roomData.gameState === "gameEnd"
          ) {
            choiceDisplay = player.currentChoice ?? "Không chọn";
          }

          // Đánh dấu chủ phòng
          const hostBadge =
            pid === roomData.hostId
              ? '<span class="text-xs text-yellow-400" title="Chủ phòng">👑</span>'
              : "";
          const myBadge =
            pid === userId
              ? '<span class="text-xs text-blue-400" title="Bạn">(Bạn)</span>'
              : "";

          card.innerHTML = `
                    <h3 class="text-base md:text-lg font-bold truncate">${
                      player.name
                    } ${hostBadge} ${myBadge}</h3>
                    <p class="text-xl md:text-2xl font-black ${getScoreColor(
                      player.score
                    )}">Điểm: ${player.score}</p>
                    <p class="text-sm text-gray-400 mt-1">Đã chọn: <span class="font-bold text-base md:text-xl text-white">${choiceDisplay}</span></p>
                    ${readyIndicator}
                `;

          // Thêm class đặc biệt
          if (player.isEliminated) {
            card.classList.add("eliminated");
          }
          if (
            roomData.gameState === "roundEnd" &&
            roomData.roundWinners.includes(pid)
          ) {
            card.classList.add("winner");
          }
          if (roomData.gameState === "roundEnd" && roomData.roundLosers[pid]) {
            card.classList.add("loser");
          }

          playerList.appendChild(card);
        });
      }

      function getScoreColor(score) {
        if (score > 5) return "text-green-400";
        if (score < 5 && score > 0) return "text-yellow-400";
        if (score <= 0) return "text-red-500";
        return "text-blue-400";
      }

      /**
       * Render trạng thái Lobby
       */
      function renderLobby(roomData) {
        lobbyState.classList.remove("hidden");
        const myData = roomData.players[userId];
        if (myData) {
          readyBtn.disabled = false;
          if (myData.isReady) {
            readyBtn.textContent = "Hủy Sẵn sàng";
            readyBtn.classList.remove("bg-green-600", "hover:bg-green-700");
            readyBtn.classList.add("bg-yellow-600", "hover:bg-yellow-700");
          } else {
            readyBtn.textContent = "Sẵn sàng";
            readyBtn.classList.remove("bg-yellow-600", "hover:bg-yellow-700");
            readyBtn.classList.add("bg-green-600", "hover:bg-green-700");
          }
        }
      }

      /**
       * Render trạng thái Đang chơi
       */
      function renderPlaying(roomData) {
        playingState.classList.remove("hidden");
        playingRoundDisplay.textContent = roomData.round;

        const myData = roomData.players[userId];

        // Nếu bị loại, không cho chơi
        if (!myData || myData.isEliminated) {
          document.getElementById("number-slider").disabled = true;
          submitNumberBtn.disabled = true;
          submitNumberBtn.classList.add("hidden");
          waitingForOthers.classList.remove("hidden");
          waitingForOthers.querySelector("p").textContent =
            "Bạn đã bị loại. Đang chờ kết quả...";
        }
        // Nếu đã nộp, chờ
        else if (myData.submittedThisRound) {
          document.getElementById("number-slider").disabled = true;
          submitNumberBtn.disabled = true;
          submitNumberBtn.classList.add("hidden");
          waitingForOthers.classList.remove("hidden");
          waitingForOthers.querySelector(
            "p"
          ).textContent = `Đã chốt số ${myData.currentChoice}! Đang chờ người khác...`;
        }
        // Nếu chưa nộp, cho chơi
        else {
          document.getElementById("number-slider").disabled = false;
          submitNumberBtn.disabled = false;
          submitNumberBtn.classList.remove("hidden");
          waitingForOthers.classList.add("hidden");
        }

        // Cập nhật timer
        const deadline = roomData.roundDeadline.toDate();

        function updateTimer() {
          const remaining = Math.max(
            0,
            Math.floor((deadline.getTime() - Date.now()) / 1000)
          );
          timerDisplay.textContent = remaining;
          if (remaining <= 10) {
            timerDisplay.classList.add("text-red-600");
          } else {
            timerDisplay.classList.remove("text-red-600");
          }
          if (remaining === 0) {
            clearInterval(uiTimerInterval);
            // Không làm gì thêm, chờ host tính toán
          }
        }

        updateTimer();
        uiTimerInterval = setInterval(updateTimer, 1000);
      }

      /**
       * Render trạng thái Kết thúc vòng
       */
      function renderRoundEnd(roomData) {
        roundEndState.classList.remove("hidden");
        roundEndRoundDisplay.textContent = roomData.round;
        averageDisplay.textContent = roomData.roundAverage.toFixed(2);

        // Hiển thị người thắng/thua
        winnersList.innerHTML = "";
        if (roomData.roundWinners.length > 0) {
          roomData.roundWinners.forEach((pid) => {
            const player = roomData.players[pid];
            if (player) {
              const li = document.createElement("li");
              li.textContent = `${player.name} (Chọn: ${player.currentChoice})`;
              winnersList.appendChild(li);
            }
          });
        } else {
          winnersList.innerHTML = "<li>Không có ai thắng vòng này.</li>";
        }

        losersList.innerHTML = "";
        const loserIds = Object.keys(roomData.roundLosers);
        if (loserIds.length > 0) {
          loserIds.forEach((pid) => {
            const player = roomData.players[pid];
            const penalty = roomData.roundLosers[pid];
            if (player) {
              const li = document.createElement("li");
              li.textContent = `${player.name} (Chọn: ${player.currentChoice}) [${penalty} điểm]`;
              losersList.appendChild(li);
            }
          });
        } else {
          losersList.innerHTML = "<li>Không có ai bị trừ điểm vòng này.</li>";
        }

        // Chỉ chủ phòng thấy nút "Next Round"
        if (isHost) {
          nextRoundBtn.classList.remove("hidden");
          waitingForHost.classList.add("hidden");
        } else {
          nextRoundBtn.classList.add("hidden");
          waitingForHost.classList.remove("hidden");
        }
      }

      /**
       * Render trạng thái Kết thúc game
       */
      function renderGameEnd(roomData) {
        gameEndState.classList.remove("hidden");
        rankings.innerHTML = "";

        const rankedPlayers = Object.values(roomData.players).sort(
          (a, b) => b.score - a.score
        );

        const medals = ["🥇", "🥈", "🥉"];

        rankedPlayers.forEach((player, index) => {
          const rankItem = document.createElement("div");
          rankItem.className =
            "flex justify-between items-center bg-gray-700 p-4 rounded-lg text-lg";

          const rankText = medals[index]
            ? `${medals[index]} ${index + 1}. ${player.name}`
            : `${index + 1}. ${player.name}`;

          rankItem.innerHTML = `
                    <span class="font-bold ${
                      index < 3 ? "text-yellow-300" : ""
                    }">${rankText}</span>
                    <span class="font-bold">${player.score} điểm</span>
                `;
          rankings.appendChild(rankItem);
        });

        // Chỉ chủ phòng thấy nút "Reset"
        if (isHost) {
          resetGameBtn.classList.remove("hidden");
          waitingForReset.classList.add("hidden");
        } else {
          resetGameBtn.classList.add("hidden");
          waitingForReset.classList.remove("hidden");
        }
      }

      // Biến toàn cục để lưu trữ dữ liệu phòng mới nhất
      window.currentRoomData = null;

      // --- GẮN SỰ KIỆN ---

      window.onload = () => {
        initFirebase();

        // Lấy tên đã lưu
        playerNameInput.value = localStorage.getItem("playerName") || "";

        createRoomBtn.onclick = handleCreateRoom;
        joinRoomBtn.onclick = handleJoinRoom;
        readyBtn.onclick = handleReady;
        submitNumberBtn.onclick = handleSubmitNumber;

        // Nút chỉ dành cho host
        nextRoundBtn.onclick = () => {
          // Sử dụng dữ liệu phòng mới nhất từ snapshot
          if (isHost && window.currentRoomData) {
            startGame(window.currentRoomData);
          }
        };
        resetGameBtn.onclick = handleResetGame;

        // Cập nhật giá trị thanh trượt
        numberSlider.oninput = (e) => {
          sliderValue.textContent = e.target.value;
        };

        // Copy Room ID
        roomIdDisplay.onclick = () => {
          if (currentRoomId) {
            // Dùng execCommand vì clipboard.writeText có thể bị chặn trong iframe
            const textArea = document.createElement("textarea");
            textArea.value = currentRoomId;
            textArea.style.position = "fixed"; // Tránh cuộn trang
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
              document.execCommand("copy");
              showMessage(`Đã copy Room ID: ${currentRoomId}`);
            } catch (err) {
              showMessage("Không thể copy ID!", true);
            }
            document.body.removeChild(textArea);
          }
        };
      };
    </script>
  </body>
</html>
